"""
HD Visualization Script for Existing Ice Predictions

This script loads previously saved 4-day prediction outputs generated by the U-Net
forecasting model. It produces two visualization types for each forecast day:

1. Normal HD PNG:
   - Correct geographic orientation (north at the top)
   - Fixed color scale (0-6)
   - Axis labels: Longitude (x axis) and Latitude (y axis)

2. Grid-overlay PNG:
   - Dense 50-pixel grid lines
   - Small coordinate labels every 50 px
   - Same axis titles as the normal version

It also produces TWO animated GIFs:
   - forecast_hd.gif          (clean images)
   - forecast_hd_grid.gif     (grid-overlay images)

This script does NOT retrain the model. It only visualizes existing predictions.

---------------------------------------------------------------------------
Directory assumption:
   predictions_ver_X/
       4day_predictions.npy
---------------------------------------------------------------------------
"""

import os
import numpy as np
import matplotlib.pyplot as plt
import imageio.v2 as imageio

# -------------------------------------------------------------
# CONFIGURATION
# -------------------------------------------------------------

SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
PRED_FILE = "4day_predictions.npy"

# Identify most recent predictions_ver_X directory
candidates = []
for entry in os.listdir(SCRIPT_DIR):
    if entry.startswith("predictions_ver_"):
        try:
            version = int(entry.split("_")[-1])
            path = os.path.join(SCRIPT_DIR, entry, PRED_FILE)
            if os.path.isfile(path):
                candidates.append((version, path))
        except ValueError:
            pass

if not candidates:
    raise FileNotFoundError("No directory containing 4day_predictions.npy found.")

PRED_PATH = max(candidates, key=lambda t: t[0])[1]
print(f"Using predictions file: {PRED_PATH}")

# Auto-increment output folder
BASE_OUT = os.path.join(os.path.dirname(PRED_PATH), "viz_hd")
i = 1
OUT_DIR = f"{BASE_OUT}_{i}"
while os.path.exists(OUT_DIR):
    i += 1
    OUT_DIR = f"{BASE_OUT}_{i}"
os.makedirs(OUT_DIR)
print("Saving outputs to:", OUT_DIR)

DAY_LABELS = ["Feb01", "Feb02", "Feb03", "Feb04"]

V_MIN = 0.0
V_MAX = 6.0

# Grid settings
GRID_SPACING = 50
TICK_LABEL_SIZE = 7
GRID_COLOR = "gray"
GRID_ALPHA = 0.35
GRID_LINEWIDTH = 0.6

# -------------------------------------------------------------
# LOAD PREDICTION ARRAY
# -------------------------------------------------------------

print("Loading predictions...")
preds = np.load(PRED_PATH)
print("Prediction array shape:", preds.shape)  # expected: (4,1024,1024)

# -------------------------------------------------------------
# GRID OVERLAY FUNCTION
# -------------------------------------------------------------

def add_dense_grid(ax, img_shape):
    h, w = img_shape

    xticks = np.arange(0, w, GRID_SPACING)
    yticks = np.arange(0, h, GRID_SPACING)

    ax.set_xticks(xticks)
    ax.set_yticks(yticks)

    ax.set_xticklabels([str(x) for x in xticks], fontsize=TICK_LABEL_SIZE)
    ax.set_yticklabels([str(y) for y in yticks], fontsize=TICK_LABEL_SIZE)

    for x in xticks:
        ax.axvline(x, color=GRID_COLOR, alpha=GRID_ALPHA, linewidth=GRID_LINEWIDTH)
    for y in yticks:
        ax.axhline(y, color=GRID_COLOR, alpha=GRID_ALPHA, linewidth=GRID_LINEWIDTH)

    return ax

# -------------------------------------------------------------
# GENERATE PNG VISUALIZATIONS
# -------------------------------------------------------------

print("Rendering PNGs...")

normal_paths = []
grid_paths = []

for pred, label in zip(preds, DAY_LABELS):

    pred_flipped = np.rot90(pred, 2)

    # -------------------
    # NORMAL VERSION
    # -------------------
    fig, ax = plt.subplots(figsize=(12, 12), dpi=160)
    img = ax.imshow(pred_flipped, cmap="Blues", vmin=V_MIN, vmax=V_MAX)

    ax.set_title(f"Ice Forecast - {label}", fontsize=20)
    ax.set_xlabel("Longitude (grid index)", fontsize=14)
    ax.set_ylabel("Latitude (grid index)", fontsize=14)

    cbar = plt.colorbar(img)
    cbar.set_label("Ice Concentration (0-6 scale)", fontsize=14)

    out_path = os.path.join(OUT_DIR, f"{label}.png")
    plt.savefig(out_path, dpi=160, bbox_inches="tight")
    plt.close()
    normal_paths.append(out_path)

    # -------------------
    # GRID VERSION
    # -------------------
    fig, ax = plt.subplots(figsize=(12, 12), dpi=160)
    img = ax.imshow(pred_flipped, cmap="Blues", vmin=V_MIN, vmax=V_MAX)

    ax.set_title(f"Ice Forecast - {label} (Grid Overlay)", fontsize=20)
    add_dense_grid(ax, pred_flipped.shape)

    ax.set_xlabel("Longitude (grid index)", fontsize=12)
    ax.set_ylabel("Latitude (grid index)", fontsize=12)

    cbar = plt.colorbar(img)
    cbar.set_label("Ice Concentration (0-6 scale)", fontsize=12)

    grid_path = os.path.join(OUT_DIR, f"{label}_grid.png")
    plt.savefig(grid_path, dpi=160, bbox_inches="tight")
    plt.close()
    grid_paths.append(grid_path)

# -------------------------------------------------------------
# GIF GENERATION (two versions)
# -------------------------------------------------------------

print("Creating GIFs...")

# Clean GIF — 16 seconds total (4 sec per frame across 4 frames)
gif_clean = os.path.join(OUT_DIR, "forecast_hd.gif")
imageio.mimsave(gif_clean, [imageio.imread(p) for p in normal_paths], duration=4.0)

# Grid GIF — matching 16-second runtime
gif_grid = os.path.join(OUT_DIR, "forecast_hd_grid.gif")
imageio.mimsave(gif_grid, [imageio.imread(p) for p in grid_paths], duration=4.0)

print("\nAll visualizations complete!")
print("Output directory:", OUT_DIR)
print("Clean GIF:", gif_clean)
print("Grid GIF:", gif_grid)
